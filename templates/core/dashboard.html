{% extends 'base.html' %}

{% block title %}Dashboard - Controle de Qualidade{% endblock %}

{% block content %}
<div class="row">
    <!-- Header com resumo do dia -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-day"></i> Resumo de Hoje - {{ today|date:"d/m/Y" }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <h3 class="text-primary mb-1">{{ daily_summary.spot_analyses.total }}</h3>
                            <small class="text-muted">Análises Pontuais</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <h3 class="text-success mb-1">{{ daily_summary.spot_analyses.approved }}</h3>
                            <small class="text-muted">Aprovadas</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <h3 class="text-warning mb-1">{{ daily_summary.spot_analyses.alert }}</h3>
                            <small class="text-muted">Em Alerta</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3">
                            <h3 class="text-danger mb-1">{{ daily_summary.spot_analyses.rejected }}</h3>
                            <small class="text-muted">Rejeitadas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Tendência Diária -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up"></i> Tendência de Análises (Últimos 7 Dias)
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="loadTrendChart(7)">7 dias</button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadTrendChart(30)">30 dias</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Distribuição por Status -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-pie-chart"></i> Distribuição por Status
                </h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Performance por Linha -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-diagram-3"></i> Performance por Linha de Produção
                </h6>
            </div>
            <div class="card-body">
                {% for line_data in lines_data %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">{{ line_data.line.name }}</span>
                            <span class="badge bg-primary">{{ line_data.approval_rate|floatformat:1 }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ line_data.approval_rate }}%"
                                 aria-valuenow="{{ line_data.approval_rate }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">{{ line_data.total_analyses }} análises nos últimos 7 dias</small>
                    </div>
                {% empty %}
                    <p class="text-muted text-center">Nenhum dado disponível</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Propriedades Analisadas -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-list-ol"></i> Propriedades Mais Analisadas
                </h6>
            </div>
            <div class="card-body">
                {% for prop in top_properties %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>{{ prop.property__identifier }}</strong><br>
                            <small class="text-muted">{{ prop.property__name }}</small>
                        </div>
                        <span class="badge bg-secondary">{{ prop.count }}</span>
                    </div>
                {% empty %}
                    <p class="text-muted text-center">Nenhum dado disponível</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning"></i> Análises Avançadas
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <a href="{% url 'quality_control:control_chart' %}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column justify-content-center align-items-center" style="min-height: 80px;">
                            <i class="bi bi-graph-up-arrow fs-3 mb-2"></i>
                            <span>Cartas de Controle</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6">
                        <a href="{% url 'quality_control:capability_analysis' %}" class="btn btn-outline-success w-100 h-100 d-flex flex-column justify-content-center align-items-center" style="min-height: 80px;">
                            <i class="bi bi-bullseye fs-3 mb-2"></i>
                            <span>Capabilidade</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6">
                        <a href="{% url 'quality_control:correlation_analysis' %}" class="btn btn-outline-info w-100 h-100 d-flex flex-column justify-content-center align-items-center" style="min-height: 80px;">
                            <i class="bi bi-diagram-2 fs-3 mb-2"></i>
                            <span>Correlações</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-6">
                        <a href="{% url 'quality_control:spot_analysis' %}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column justify-content-center align-items-center" style="min-height: 80px;">
                            <i class="bi bi-table fs-3 mb-2"></i>
                            <span>Relatórios</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let trendChart, statusChart;
    
    // Inicializar gráficos quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        loadTrendChart(7);
        loadStatusChart();
    });
    
    // Carregar gráfico de tendência
    function loadTrendChart(days) {
        fetch(`/api/dashboard-data/?type=trends&days=${days}`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('trendChart').getContext('2d');
                
                if (trendChart) {
                    trendChart.destroy();
                }
                
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.approval_trend.map(item => item.date),
                        datasets: [{
                            label: 'Taxa de Aprovação (%)',
                            data: data.approval_trend.map(item => item.approval_rate),
                            borderColor: 'rgb(44, 85, 48)',
                            backgroundColor: 'rgba(44, 85, 48, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Total de Análises',
                            data: data.approval_trend.map(item => item.total),
                            borderColor: 'rgb(127, 176, 105)',
                            backgroundColor: 'rgba(127, 176, 105, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Taxa de Aprovação (%)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Número de Análises'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
                
                // Atualizar botões ativos
                document.querySelectorAll('.btn-group .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            })
            .catch(error => {
                console.error('Erro ao carregar dados de tendência:', error);
            });
    }
    
    // Carregar gráfico de status
    function loadStatusChart() {
        fetch('/api/dashboard-data/?type=summary')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('statusChart').getContext('2d');
                
                if (statusChart) {
                    statusChart.destroy();
                }
                
                const statusLabels = {
                    'APPROVED': 'Aprovado',
                    'ALERT': 'Alerta',
                    'REJECTED': 'Rejeitado'
                };
                
                const statusColors = {
                    'APPROVED': '#198754',
                    'ALERT': '#fd7e14',
                    'REJECTED': '#dc3545'
                };
                
                statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.status_distribution.map(item => statusLabels[item.status] || item.status),
                        datasets: [{
                            data: data.status_distribution.map(item => item.count),
                            backgroundColor: data.status_distribution.map(item => statusColors[item.status] || '#6c757d'),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Erro ao carregar dados de status:', error);
            });
    }
    
    // Atualizar dados automaticamente a cada 5 minutos
    setInterval(function() {
        loadTrendChart(7);
        loadStatusChart();
    }, 300000);
</script>
{% endblock %}
