{% extends 'base.html' %}

{% block title %}Exportação de Dados{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-download"></i> Exportação de Dados
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'core:export_data' %}">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="export_type" class="form-label">Tipo de Dados</label>
                            <select class="form-select" id="export_type" name="export_type" required>
                                <option value="">Selecione o tipo de dados</option>
                                {% for value, label in export_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="format" class="form-label">Formato</label>
                            <select class="form-select" id="format" name="format" required>
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="start_date" name="start_date">
                            <div class="form-text">Deixe em branco para incluir todos os dados</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="end_date" class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="end_date" name="end_date">
                            <div class="form-text">Deixe em branco para incluir até hoje</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="line_id" class="form-label">Linha de Produção</label>
                            <select class="form-select" id="line_id" name="line_id">
                                <option value="">Todas as linhas</option>
                                {% for line in production_lines %}
                                    <option value="{{ line.id }}">{{ line.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-download"></i> Exportar Dados
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Exportações Rápidas -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning"></i> Exportações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="bi bi-calendar-week text-primary fs-1 mb-3"></i>
                                <h6>Análises da Semana</h6>
                                <p class="text-muted small">Últimos 7 dias</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportWeekData()">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="bi bi-calendar-month text-success fs-1 mb-3"></i>
                                <h6>Análises do Mês</h6>
                                <p class="text-muted small">Mês atual</p>
                                <button class="btn btn-outline-success btn-sm" onclick="exportMonthData()">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <i class="bi bi-file-earmark-text text-info fs-1 mb-3"></i>
                                <h6>Todos os Laudos</h6>
                                <p class="text-muted small">Histórico completo</p>
                                <button class="btn btn-outline-info btn-sm" onclick="exportAllReports()">
                                    <i class="bi bi-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas de Dados -->
<div class="row">
    <div class="col-md-3 col-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-primary" id="totalAnalyses">-</h4>
                <small class="text-muted">Total de Análises</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-success" id="totalReports">-</h4>
                <small class="text-muted">Total de Laudos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-info" id="totalSamples">-</h4>
                <small class="text-muted">Amostras Compostas</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="text-warning" id="recentAnalyses">-</h4>
                <small class="text-muted">Últimos 30 dias</small>
            </div>
        </div>
    </div>
</div>

<!-- Instruções -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Instruções de Uso
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Formatos Disponíveis:</h6>
                        <ul>
                            <li><strong>Excel (.xlsx):</strong> Formato recomendado com formatação e gráficos</li>
                            <li><strong>CSV (.csv):</strong> Formato simples para importação em outros sistemas</li>
                        </ul>
                        
                        <h6>Filtros:</h6>
                        <ul>
                            <li><strong>Data:</strong> Filtra por período específico</li>
                            <li><strong>Linha:</strong> Filtra por linha de produção</li>
                            <li><strong>Tipo:</strong> Seleciona o tipo de dados a exportar</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Tipos de Dados:</h6>
                        <ul>
                            <li><strong>Análises Pontuais:</strong> Todas as medições realizadas durante os turnos</li>
                            <li><strong>Amostras Compostas:</strong> Amostras coletadas ao final de cada turno</li>
                            <li><strong>Laudos de Qualidade:</strong> Relatórios oficiais de qualidade</li>
                        </ul>
                        
                        <h6>Dicas:</h6>
                        <ul>
                            <li>Use Excel para análises detalhadas</li>
                            <li>Use CSV para integração com outros sistemas</li>
                            <li>Filtre por período para arquivos menores</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Carregar estatísticas
    document.addEventListener('DOMContentLoaded', function() {
        loadSystemStats();
        
        // Configurar datas padrão
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
        document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
    });
    
    function loadSystemStats() {
        fetch('/api/system-stats/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalAnalyses').textContent = data.total_analyses.toLocaleString();
                document.getElementById('totalReports').textContent = data.total_reports.toLocaleString();
                document.getElementById('totalSamples').textContent = data.total_samples.toLocaleString();
                document.getElementById('recentAnalyses').textContent = data.recent_analyses.toLocaleString();
            })
            .catch(error => {
                console.error('Erro ao carregar estatísticas:', error);
            });
    }
    
    function exportWeekData() {
        const form = document.querySelector('form');
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        // Configurar formulário
        document.getElementById('export_type').value = 'spot_analyses';
        document.getElementById('format').value = 'excel';
        document.getElementById('start_date').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
        
        // Submeter
        form.submit();
    }
    
    function exportMonthData() {
        const form = document.querySelector('form');
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // Configurar formulário
        document.getElementById('export_type').value = 'spot_analyses';
        document.getElementById('format').value = 'excel';
        document.getElementById('start_date').value = firstDay.toISOString().split('T')[0];
        document.getElementById('end_date').value = today.toISOString().split('T')[0];
        
        // Submeter
        form.submit();
    }
    
    function exportAllReports() {
        const form = document.querySelector('form');
        
        // Configurar formulário
        document.getElementById('export_type').value = 'quality_reports';
        document.getElementById('format').value = 'excel';
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        
        // Submeter
        form.submit();
    }
    
    // Validação do formulário
    document.querySelector('form').addEventListener('submit', function(e) {
        const exportType = document.getElementById('export_type').value;
        const format = document.getElementById('format').value;
        
        if (!exportType || !format) {
            e.preventDefault();
            alert('Por favor, selecione o tipo de dados e o formato.');
            return;
        }
        
        // Mostrar loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exportando...';
        submitBtn.disabled = true;
        
        // Restaurar botão após 5 segundos
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 5000);
    });
    
    // Atualizar data final quando data inicial mudar
    document.getElementById('start_date').addEventListener('change', function() {
        const startDate = new Date(this.value);
        const endDateInput = document.getElementById('end_date');
        
        if (!endDateInput.value || new Date(endDateInput.value) < startDate) {
            endDateInput.value = this.value;
        }
    });
</script>
{% endblock %}
