<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova An√°lise Pontual - Brasil Min√©rios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .form-control, .form-select {
            font-size: 16px; /* Evita zoom no iOS */
        }
        .property-input {
            margin-bottom: 15px;
        }
        .property-card {
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-gem"></i> Brasil Min√©rios
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/qc/dashboard/">Dashboard</a>
                <a class="nav-link" href="/qc/spot-analysis/">An√°lises</a>
                <a class="nav-link" href="/admin/">Admin</a>
                <span class="navbar-text ms-3">
                    <i class="bi bi-person-circle"></i> {{ user.username }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-plus-circle"></i> Nova An√°lise Pontual</h2>
                    <a href="/qc/spot-analysis/" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
        </div>

        <form method="post" id="analysisForm">
            <div class="row">
                <!-- Informa√ß√µes B√°sicas -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informa√ß√µes B√°sicas</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="id_product" class="form-label">Produto *</label>
                                <select name="product" id="id_product" class="form-select" required>
                                    <option value="">Selecione o produto</option>
                                    {% for product in products %}
                                        <option value="{{ product.id }}" data-code="{{ product.code }}">
                                            {{ product.name }} ({{ product.code }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="id_line" class="form-label">Linha de Produ√ß√£o *</label>
                                <select name="line" id="id_line" class="form-select" required>
                                    <option value="">Selecione a linha</option>
                                    {% for line in lines %}
                                        <option value="{{ line.id }}">{{ line.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="id_shift" class="form-label">Turno *</label>
                                <select name="shift" id="id_shift" class="form-select" required>
                                    {% for shift in shifts %}
                                        <option value="{{ shift.id }}" 
                                                {% if current_shift and shift.id == current_shift.id %}selected{% endif %}>
                                            Turno {{ shift.name }} ({{ shift.start_time|time:"H:i" }} - {{ shift.end_time|time:"H:i" }})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="id_analysis_datetime" class="form-label">Data e Hora da An√°lise *</label>
                                <input type="datetime-local" name="analysis_datetime" id="id_analysis_datetime" 
                                       class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label for="id_sample_id" class="form-label">ID da Amostra</label>
                                <input type="text" name="sample_id" id="id_sample_id" 
                                       class="form-control" placeholder="Ex: VRM-001-20250923">
                            </div>

                            <div class="mb-3">
                                <label for="id_observations" class="form-label">Observa√ß√µes</label>
                                <textarea name="observations" id="id_observations" 
                                          class="form-control" rows="3" 
                                          placeholder="Observa√ß√µes sobre a an√°lise..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Propriedades do Produto -->
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-sliders"></i> Propriedades para An√°lise</h6>
                        </div>
                        <div class="card-body">
                            <div id="properties-container">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    Selecione um produto para ver as propriedades dispon√≠veis.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <a href="/qc/spot-analysis/" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Salvar An√°lise
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Definir data/hora atual
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('id_analysis_datetime').value = localDateTime;

            // Gerar ID da amostra automaticamente
            function generateSampleId() {
                const product = document.getElementById('id_product');
                const line = document.getElementById('id_line');
                const date = new Date();
                
                if (product.value && line.value) {
                    const productCode = product.options[product.selectedIndex].getAttribute('data-code') || 'XXX';
                    const lineCode = line.options[line.selectedIndex].text.replace('Linha ', 'L');
                    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                    const timeStr = date.toTimeString().slice(0, 5).replace(':', '');
                    
                    const sampleId = `${productCode}-${lineCode}-${dateStr}-${timeStr}`;
                    document.getElementById('id_sample_id').value = sampleId;
                }
            }

            // Carregar propriedades do produto
            function loadProductProperties(productId) {
                if (!productId) {
                    document.getElementById('properties-container').innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Selecione um produto para ver as propriedades dispon√≠veis.
                        </div>
                    `;
                    return;
                }

                // Mostrar loading
                document.getElementById('properties-container').innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando propriedades...</p>
                    </div>
                `;

                // Simular carregamento de propriedades (substitua pela chamada real da API)
                setTimeout(() => {
                    const mockProperties = [
                        {name: 'Umidade', unit: '%', type: 'physical', min_value: 0, max_value: 15, target_value: 8},
                        {name: 'Granulometria', unit: 'mesh', type: 'physical', min_value: 100, max_value: 200, target_value: 150},
                        {name: 'SiO2', unit: '%', type: 'chemical', min_value: 35, max_value: 45, target_value: 40},
                        {name: 'Al2O3', unit: '%', type: 'chemical', min_value: 10, max_value: 18, target_value: 14},
                        {name: 'Fe2O3', unit: '%', type: 'chemical', min_value: 5, max_value: 12, target_value: 8}
                    ];

                    let html = '';
                    mockProperties.forEach((prop, index) => {
                        const typeColor = prop.type === 'physical' ? 'primary' : 'success';
                        const typeIcon = prop.type === 'physical' ? 'rulers' : 'flask';
                        
                        html += `
                            <div class="property-card card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            <i class="bi bi-${typeIcon} text-${typeColor}"></i>
                                            ${prop.name}
                                        </h6>
                                        <span class="badge bg-${typeColor}">${prop.unit}</span>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <label class="form-label">Valor Medido:</label>
                                            <input type="number" 
                                                   name="property_${index}_value" 
                                                   class="form-control" 
                                                   step="0.01"
                                                   placeholder="Digite o valor medido">
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-4">
                                            <small class="text-muted">M√≠n: ${prop.min_value}</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <small class="text-muted">Alvo: ${prop.target_value}</small>
                                        </div>
                                        <div class="col-4 text-end">
                                            <small class="text-muted">M√°x: ${prop.max_value}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('properties-container').innerHTML = html;
                }, 1000);
            }

            // Event listeners
            document.getElementById('id_product').addEventListener('change', function() {
                loadProductProperties(this.value);
                generateSampleId();
            });

            document.getElementById('id_line').addEventListener('change', generateSampleId);

            console.log('üéâ Formul√°rio de an√°lise pontual carregado!');
        });
    </script>
</body>
</html>
